<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>White Dwarf Papers Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }
        
        .control-group label {
            color: white;
            font-weight: 500;
        }
        
        .control-group input, .control-group select {
            padding: 8px 12px;
            border: none;
            border-radius: 15px;
            background: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255,107,107,0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,107,0.4);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: #ffd700;
        }
        
        .stat-card p {
            opacity: 0.9;
        }
        
        .map-container {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        #map {
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .legend {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .legend h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .legend-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 50px 0;
        }
        
        .error {
            background: rgba(255,0,0,0.1);
            border: 1px solid rgba(255,0,0,0.3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .paper-popup {
            max-width: 300px;
        }
        
        .paper-popup h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }
        
        .paper-popup p {
            margin: 5px 0;
            font-size: 12px;
        }
        
        .citation-badge {
            background: #4a90e2;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü White Dwarf Papers Tracker</h1>
            <p>Exploring stellar remnants research from around the world</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="yearRange">Year Range:</label>
                <select id="yearRange">
                    <option value="2024-2024">2024</option>
                    <option value="2023-2024">2023-2024</option>
                    <option value="2020-2024" selected>2020-2024</option>
                    <option value="2015-2024">2015-2024</option>
                    <option value="2010-2024">2010-2024</option>
                </select>
            </div>
            <div class="control-group">
                <label for="minCitations">Min Citations:</label>
                <input type="number" id="minCitations" value="0" min="0">
            </div>
            <button class="btn" onclick="fetchPapers()">üîÑ Update Data</button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalPapers">0</h3>
                <p>Total Papers</p>
            </div>
            <div class="stat-card">
                <h3 id="totalInstitutions">0</h3>
                <p>Institutions</p>
            </div>
            <div class="stat-card">
                <h3 id="totalCitations">0</h3>
                <p>Total Citations</p>
            </div>
            <div class="stat-card">
                <h3 id="avgCitations">0</h3>
                <p>Avg Citations</p>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="legend">
            <h3>Legend - Citation Ranges</h3>
            <div class="legend-item">
                <div class="legend-circle" style="background: #ff4757; width: 8px; height: 8px;"></div>
                <span>0-9 citations</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background: #ffa502; width: 12px; height: 12px;"></div>
                <span>10-49 citations</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background: #3742fa; width: 16px; height: 16px;"></div>
                <span>50-99 citations</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background: #2ed573; width: 20px; height: 20px;"></div>
                <span>100+ citations</span>
            </div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            Loading white dwarf papers...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let markersLayer;
        let allPapers = [];
        
        // Initialize the map
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            markersLayer = L.layerGroup().addTo(map);
        }
        
        // üîê SECURE VERSION: No API tokens in browser!
        // Data is fetched server-side by GitHub Actions and stored in JSON file
        let allPapersData = {}; // Will contain data for all year ranges
        
        // Load papers data from JSON file (generated by GitHub Actions)
        async function loadPapersData() {
            try {
                console.log('Attempting to load papers data from JSON file...');
                const response = await fetch('./data/papers-data.json?t=' + Date.now()); // Cache busting
                
                if (!response.ok) {
                    console.error(`Failed to load papers data: ${response.status} ${response.statusText}`);
                    throw new Error(`Failed to load papers data: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Raw data loaded:', data);
                
                allPapersData = data.yearRanges || {};
                console.log('Year ranges available:', Object.keys(allPapersData));
                
                // Log papers count for each year range
                for (const [yearRange, papers] of Object.entries(allPapersData)) {
                    console.log(`${yearRange}: ${papers.length} papers`);
                }
                
                // Update last updated info
                const lastUpdated = new Date(data.lastUpdated).toLocaleDateString();
                document.querySelector('.header p').textContent = 
                    `Tracking ${data.totalPapers || 0} real white dwarf papers from NASA ADS (Updated: ${lastUpdated})`;
                
                console.log(`Successfully loaded ${data.totalPapers || 0} papers from NASA ADS data file`);
                return true;
                
            } catch (error) {
                console.error('Error loading papers data:', error);
                console.log('Falling back to sample data...');
                // Fallback to sample data if file doesn't exist
                allPapersData = { '2020-2024': generateFallbackData() };
                document.querySelector('.header p').textContent = 
                    'Demo mode: Showing sample data (GitHub Actions data file not accessible)';
                return false;
            }
        }
        
        // Get papers for current filter settings
        function getCurrentPapers() {
            const yearRange = document.getElementById('yearRange').value;
            return allPapersData[yearRange] || [];
        }
        
        // Get marker color and size based on citations
        function getMarkerStyle(citations) {
            let color, size;
            
            if (citations >= 100) {
                color = '#2ed573';
                size = 20;
            } else if (citations >= 50) {
                color = '#3742fa';
                size = 16;
            } else if (citations >= 10) {
                color = '#ffa502';
                size = 12;
            } else {
                color = '#ff4757';
                size = 8;
            }
            
            return { color, size };
        }
        
        // Update map with papers
        function updateMap(papers) {
            markersLayer.clearLayers();
            
            // Group papers by location
            const locationGroups = {};
            papers.forEach(paper => {
                const key = `${paper.lat.toFixed(2)},${paper.lng.toFixed(2)}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = [];
                }
                locationGroups[key].push(paper);
            });
            
            // Create markers for each location
            Object.values(locationGroups).forEach(groupPapers => {
                const totalCitations = groupPapers.reduce((sum, paper) => sum + paper.citations, 0);
                const avgCitations = Math.round(totalCitations / groupPapers.length);
                const { color, size } = getMarkerStyle(totalCitations);
                
                const marker = L.circleMarker([groupPapers[0].lat, groupPapers[0].lng], {
                    radius: size,
                    fillColor: color,
                    color: '#333',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                }).addTo(markersLayer);
                
                // Create popup content
                let popupContent = `
                    <div class="paper-popup">
                        <h4>${groupPapers[0].institution}</h4>
                        <p><strong>Papers:</strong> ${groupPapers.length}</p>
                        <p><strong>Total Citations:</strong> <span class="citation-badge">${totalCitations}</span></p>
                        <p><strong>Avg Citations:</strong> ${avgCitations}</p>
                        <hr style="margin: 10px 0;">
                `;
                
                // Add top papers
                const sortedPapers = groupPapers.sort((a, b) => b.citations - a.citations).slice(0, 3);
                sortedPapers.forEach(paper => {
                    const shortTitle = paper.title.length > 60 ? paper.title.substring(0, 60) + '...' : paper.title;
                    const firstAuthor = paper.authors && paper.authors[0] ? paper.authors[0] : 'Unknown';
                    const nasaAdsUrl = `https://ui.adsabs.harvard.edu/abs/${paper.bibcode}/abstract`;
                    
                    popupContent += `
                        <div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                            <p><strong>${shortTitle}</strong></p>
                            <p><small>${firstAuthor} et al. (${paper.year})</small></p>
                            <p>Citations: <span class="citation-badge">${paper.citations}</span> | <em>${paper.journal || 'Unknown Journal'}</em></p>
                            <p><small>Bibcode: ${paper.bibcode}</small></p>
                            <p><a href="${nasaAdsUrl}" target="_blank" style="color: #4a90e2; text-decoration: none; font-weight: bold;">üîó View on NASA ADS</a></p>
                        </div>
                    `;
                });
                
                popupContent += '</div>';
                marker.bindPopup(popupContent);
            });
        }
        
        // Update statistics
        function updateStats(papers) {
            const totalPapers = papers.length;
            const totalCitations = papers.reduce((sum, paper) => sum + paper.citations, 0);
            const avgCitations = totalPapers > 0 ? Math.round(totalCitations / totalPapers) : 0;
            
            const institutions = new Set(papers.map(paper => paper.institution));
            const totalInstitutions = institutions.size;
            
            document.getElementById('totalPapers').textContent = totalPapers;
            document.getElementById('totalInstitutions').textContent = totalInstitutions;
            document.getElementById('totalCitations').textContent = totalCitations;
            document.getElementById('avgCitations').textContent = avgCitations;
        }
        
        // Filter papers based on controls
        function filterPapers(papers) {
            const minCitations = parseInt(document.getElementById('minCitations').value) || 0;
            return papers.filter(paper => paper.citations >= minCitations);
        }
        
        // Fetch and display papers
        async function fetchPapers() {
            console.log('üîÑ fetchPapers() function called!');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            
            try {
                console.log('üìÅ About to load papers data...');
                // Load data from JSON file (no API calls from browser!)
                await loadPapersData();
                
                // Get papers for current year range filter
                const yearRange = document.getElementById('yearRange').value;
                console.log(`üìÖ Current year range filter: ${yearRange}`);
                
                const currentPapers = getCurrentPapers();
                console.log(`üìä Papers for ${yearRange}: ${currentPapers.length}`);
                
                const filteredPapers = filterPapers(currentPapers);
                console.log(`üîç After citation filter: ${filteredPapers.length}`);
                
                updateMap(filteredPapers);
                updateStats(filteredPapers);
                
                console.log('‚úÖ Successfully updated map and stats!');
                
            } catch (error) {
                console.error('‚ùå Error loading papers:', error);
                document.getElementById('error').textContent = `Error loading papers: ${error.message}`;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Make sure function is available globally for onclick
        window.fetchPapers = fetchPapers;
        
        // Fallback sample data in case API fails
        function generateFallbackData() {
            console.log('Using fallback sample data');
            const institutions = [
                { name: "Harvard-Smithsonian Center for Astrophysics", lat: 42.3601, lng: -71.0589 },
                { name: "European Southern Observatory", lat: 48.2642, lng: -24.6272 },
                { name: "Max Planck Institute", lat: 48.2608, lng: 11.6795 },
                { name: "University of Cambridge", lat: 52.2053, lng: 0.1218 },
                { name: "Australian National University", lat: -35.2777, lng: 149.1185 }
            ];
            
            const titles = [
                "White dwarf masses in cataclysmic variables",
                "Magnetic field evolution in isolated white dwarfs",
                "Crystallization in white dwarf cores",
                "Type Ia supernovae from white dwarf mergers",
                "Pulsating white dwarfs in binary systems"
            ];
            
            return Array.from({ length: 20 }, (_, i) => {
                const institution = institutions[i % institutions.length];
                return {
                    title: titles[i % titles.length] + ` (Sample ${i+1})`,
                    authors: [`Sample Author ${i+1}`, `Co-author ${i+1}`],
                    year: 2020 + Math.floor(Math.random() * 5),
                    citations: Math.floor(Math.random() * 100),
                    institution: institution.name,
                    lat: institution.lat + (Math.random() - 0.5) * 0.3,
                    lng: institution.lng + (Math.random() - 0.5) * 0.3,
                    bibcode: `2024SAMPLE${i+1}`,
                    journal: 'Sample Journal'
                };
            });
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded, initializing...');
            initMap();
            
            // Make fetchPapers available in console for testing
            window.testFetch = fetchPapers;
            console.log('üí° Test function available: try typing "testFetch()" in console');
            
            // Initial load
            fetchPapers();
            
            // Add event listeners to controls
            document.getElementById('yearRange').addEventListener('change', () => {
                console.log('Year range changed');
                const currentPapers = getCurrentPapers();
                const filteredPapers = filterPapers(currentPapers);
                updateMap(filteredPapers);
                updateStats(filteredPapers);
            });
            
            document.getElementById('minCitations').addEventListener('input', () => {
                console.log('Min citations changed');
                const currentPapers = getCurrentPapers();
                const filteredPapers = filterPapers(currentPapers);
                updateMap(filteredPapers);
                updateStats(filteredPapers);
            });
        });
        
        // Auto-refresh every 24 hours
        setInterval(fetchPapers, 24 * 60 * 60 * 1000);
    </script>
</body>
</html>
